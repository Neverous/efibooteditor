name: Check for Qt updates

on:
  workflow_dispatch:
  schedule:
    - cron: 0 5 * * 5

concurrency:
  group: qt-update-${{ github.ref }}
  cancel-in-progress: true

jobs:
  check-qt-updates:
    name: Check Qt updates
    runs-on: ubuntu-slim

    permissions:
      actions: read
      contents: read

    steps:
      - name: Sync fork
        env:
          GITHUB_TOKEN: ${{ secrets.BOT_ACCESS_TOKEN }}
        run: |
          gh repo sync EFIBootEditorBot/efibooteditor \
            --source ${{ github.repository }} \
            --branch master \
            --force

      - name: Checkout source code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          token: ${{ secrets.BOT_ACCESS_TOKEN }}
          repository: EFIBootEditorBot/efibooteditor

      - name: Install uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b
        with:
          enable-cache: true

      - name: Install python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405
        with:
          python-version: '3.14'

      - name: Install dependencies
        run: uv sync
        working-directory: misc/qt-updater

      - name: Run the updater
        id: diff
        run: |
          uv run -m main ../../.github/workflows/*.yml
          if git diff --exit-code ../../.github/workflows/; then
            echo "changed=false" >> "${GITHUB_OUTPUT}"
          else
            echo "changed=true" >> "${GITHUB_OUTPUT}"
          fi
        working-directory: misc/qt-updater

      - name: Create pull request
        run: |
          CURRENT_SHA=$(gh api repos/EFIBootEditorBot/efibooteditor/git/ref/heads/master --jq '.object.sha')
          if ! gh api repos/EFIBootEditorBot/efibooteditor/git/refs -f ref="refs/heads/qt-update" -f sha="${CURRENT_SHA}" 2>/dev/null; then
            CURRENT_SHA=$(gh api repos/EFIBootEditorBot/efibooteditor/git/ref/heads/qt-update --jq '.object.sha')
          fi

          gh api graphql -f query='
            mutation($repo: String!, $branch: String!, $oid: GitObjectID!, $msg: String!, $files: [FileAddition!]!) {
              createCommitOnBranch(input: {
                branch: { repositoryNameWithOwner: $repo, branchName: $branch },
                expectedHeadOid: $oid,
                message: { headline: $msg },
                fileChanges: { additions: $files }
              }) { commit { url } }
            }' \
            -f repo="EFIBootEditorBot/efibooteditor" \
            -f branch="qt-update" \
            -f oid="${CURRENT_SHA}" \
            -f msg="Update Qt dependencies" \
            -f files[][path]=".github/workflows/build.yml" \
            -f files[][contents]=$(base64 -w 0 .github/workflows/build.yml) \
            -f files[][path]=".github/workflows/release.yml" \
            -f files[][contents]=$(base64 -w 0 .github/workflows/release.yml)

          gh pr create \
            --repo "${{ github.repository }}" \
            --title 'ci: update Qt versions in CI' \
            --body 'Updates Qt versions in CI to newest ones.' \
            --head "EFIBootEditorBot:qt-update" \
            --base master || echo "PR already exists"

        env:
          GITHUB_TOKEN: ${{ secrets.BOT_ACCESS_TOKEN }}
        if: steps.diff.outputs.changed == 'true'
