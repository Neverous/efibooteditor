name: Prepare release assets

on:
  push:
    branches: [master]
    paths:
      - .github/workflows/build.yml
      - .github/workflows/release.yml
      - CMakeLists.txt
      - cmake/**
      - icons.qrc
      - icons/**
      - include/**
      - src/**
      - translations/**
      - windows.rc
  tags: [v*]

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-linux:
    name: ${{ matrix.os }} with ${{ matrix.compiler }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04, ubuntu-24.04-arm]
        compiler:
          - Clang
          - GCC

    permissions:
      actions: read
      artifact-metadata: write
      attestations: write
      contents: read
      id-token: write
      security-events: write

    uses: ./.github/workflows/build.yml
    with:
      os: ${{ matrix.os }}
      compiler: ${{ matrix.compiler }}
      build-config: RelWithDebInfo
      version: ${{ github.ref_type == 'tag' && github.ref_name || github.sha }}

  build-windows:
    name: ${{ matrix.os }} with ${{ matrix.compiler }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-2022, windows-2025, windows-11-arm]
        compiler:
          - Clang
          - MSVC

    permissions:
      actions: read
      artifact-metadata: write
      attestations: write
      contents: read
      id-token: write
      security-events: write

    uses: ./.github/workflows/build.yml
    with:
      os: ${{ matrix.os }}
      compiler: ${{ matrix.compiler }}
      build-config: RelWithDebInfo
      version: ${{ github.ref_type == 'tag' && github.ref_name || github.sha }}

  build-macos:
    name: ${{ matrix.os }} with ${{ matrix.compiler }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-14, macos-15, macos-26]
        compiler:
          - Clang

    permissions:
      actions: read
      artifact-metadata: write
      attestations: write
      contents: read
      id-token: write
      security-events: write

    uses: ./.github/workflows/build.yml
    with:
      os: ${{ matrix.os }}
      compiler: ${{ matrix.compiler }}
      build-config: RelWithDebInfo
      version: ${{ github.ref_type == 'tag' && github.ref_name || github.sha }}

  upload-assets:
    name: Upload release assets
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-slim
    permissions:
      attestations: write
      contents: write
      id-token: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131
        with:
          path: artifacts

      - name: Prepare assets for release
        id: prepare
        run: |
          mkdir -p dist
          VERSION="${{ github.ref_type == 'tag' && github.ref_name || github.sha }}"

          find artifacts -type f -name "EFIBootEditor-*" | while read -r file; do
            filename=$(basename "$file")
            dir_name=$(basename "$(dirname "$file")")
            compiler="${dir_name##*-}"
            metadata=$(echo "$dir_name" | sed -E 's/EFIBootEditor-[^-]+-(.*)-[^-]+$/\1/')
            ext=$(echo "$filename" | sed -E "s/EFIBootEditor-[^-]+-.*-qt-[0-9.]+ //; s/EFIBootEditor-[^-]+-.*-qt-[0-9.]+//")

            new_name="EFIBootEditor-${VERSION}-${metadata}-${compiler}${ext}"
            echo "Renaming $filename to $new_name"
            mv -v "$file" "dist/$new_name"
          done
        shell: bash

      - name: Attest release assets
        uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f
        with:
          subject-path: dist/EFIBootEditor-*

      - name: Upload assets to release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b
        with:
          draft: ${{ github.ref_type == 'tag' }}
          prerelease: ${{ github.ref_type != 'tag' }}
          files: dist/EFIBootEditor-*
          tag_name: ${{ github.ref_type == 'tag' && github.ref_name || 'latest' }}

  winget-update:
    name: Update version in winget
    if: github.ref_type == 'tag'
    needs: upload-assets
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        os: [windows-2025]
        qt-version:
          - 6.10.2  # Supported until 2026-04-07
        compiler:
          - MSVC
    steps:
      - name: Create PR in winget-pkgs repository
        run: |
          iwr https://aka.ms/wingetcreate/latest -OutFile wingetcreate.exe
          .\wingetcreate.exe update EFIBootEditor.EFIBootEditor -u https://github.com/Neverous/efibooteditor/releases/download/${{ github.ref_name }}/EFIBootEditor-${{ github.ref_name }}-${{ matrix.os }}-qt-${{ matrix.qt-version }}-${{ matrix.compiler }}.msi -v $Env:GITHUB_REF_NAME.Substring(1) -t ${{ secrets.BOT_ACCESS_TOKEN }} --submit
