name: Create release assets

on:
  push:
    branches: [master]
  release:
    types: [published]

env:
  CMAKE_BUILD_PARALLEL_LEVEL: 4

jobs:
  build-linux:
    name: ${{ matrix.os }} Qt ${{ matrix.qt_version }} with ${{ matrix.compiler }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-20.04, ubuntu-22.04]
        qt_version:
          - 5.15.2 # OS LTS
          - 6.2.4 # LTS Standard
          - 6.4.2 # latest
        compiler:
          - Clang
          - GCC
        include:
          - os: ubuntu-18.04
            qt_version: 5.15.2
            compiler: Clang
          - os: ubuntu-18.04
            qt_version: 5.15.2
            compiler: GCC

    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Set up Qt environment
        uses: jurplel/install-qt-action@v3
        with:
          cache: true
          version: ${{ matrix.qt_version }}
          modules: ${{ startsWith(matrix.qt_version, '6') && 'qt5compat' || '' }}

      - name: Install libfuse2
        run: sudo apt-get install libfuse2
        shell: bash

      - name: Install linuxdeploy
        uses: miurahr/install-linuxdeploy-action@v1
        with:
          plugins: qt

      - name: Install efivar
        run: sudo apt-get install libefiboot1 libefiboot-dev libefivar-dev
        shell: bash

      - name: Install libxkbcommon-x11-0
        run: sudo apt-get install libxkbcommon-x11-0
        shell: bash

      - name: Create build directory
        run: mkdir -p build/release

      - name: Get release version
        id: vars
        run: echo "version=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Configure build with ${{ matrix.compiler }}
        run: |
          if [ "${{ matrix.compiler }}" = "Clang" ]; then
            export CC=clang
            export CXX=clang++
          elif [ "${{ matrix.compiler }}" = "GCC" ]; then
            export CC=gcc
            export CXX=g++
          fi;
          cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo ..
        shell: bash
        env:
          BUILD_VERSION: ${{ steps.vars.outputs.version }}
          BUILD_OS: ${{ matrix.os }}
        working-directory: build

      - name: Build
        run: |
          cmake --build . --config RelWithDebInfo --target package
        shell: bash
        working-directory: build

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: EFIBootEditor-${{ github.sha }}-${{ matrix.os }}-qt-${{ matrix.qt_version }}-${{ matrix.compiler }}
          if-no-files-found: error
          path: build/dist/EFIBootEditor-*

  build-windows:
    name: ${{ matrix.os }} Qt ${{ matrix.qt_version }} with ${{ matrix.compiler }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-2019, windows-2022]
        qt_version:
          - 5.15.2 # OS LTS
          - 6.2.4 # LTS Standard
          - 6.4.2 # latest
        compiler:
          - Clang
          - MSVC

    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Set up Qt environment
        uses: jurplel/install-qt-action@v3
        with:
          cache: true
          version: ${{ matrix.qt_version }}
          modules: ${{ startsWith(matrix.qt_version, '6') && 'qt5compat' || '' }}

      - name: Create build directory
        run: mkdir -p build/release

      - name: Get release version
        id: vars
        run: echo "version=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Configure build with ${{ matrix.compiler }}
        run: |
          if "${{ endsWith(matrix.os, '2019') }}"=="true" set VCVARSALL=%programfiles(x86)%\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvarsall.bat
          if "${{ endsWith(matrix.os, '2022') }}"=="true" set VCVARSALL=%programfiles%\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat
          call "%VCVARSALL%" x64 || exit /b
          if "${{ matrix.compiler }}"=="Clang" set COMPILER="-T ClangCL"
          cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_SYSTEM_VERSION=10.0.19041.0 %COMPILER% .. || exit /b
        shell: cmd
        env:
          BUILD_VERSION: ${{ steps.vars.outputs.version }}
          BUILD_OS: ${{ matrix.os }}
        working-directory: build

      - name: Build
        run: |
          cmake --build . --config RelWithDebInfo --target package || exit /b
        shell: cmd
        working-directory: build

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: EFIBootEditor-${{ github.sha }}-${{ matrix.os }}-qt-${{ matrix.qt_version }}-${{ matrix.compiler }}
          if-no-files-found: error
          path: build/dist/EFIBootEditor-*

  build-macos:
    name: ${{ matrix.os }} Qt ${{ matrix.qt_version }} with ${{ matrix.compiler }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-11, macos-12]
        qt_version:
          - 5.15.2 # OS LTS
          - 6.2.4 # LTS Standard
          - 6.4.2 # latest
        compiler:
          - Clang

    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Set up Qt environment
        uses: jurplel/install-qt-action@v3
        with:
          cache: true
          version: ${{ matrix.qt_version }}
          modules: ${{ startsWith(matrix.qt_version, '6') && 'qt5compat' || '' }}

      - name: Create build directory
        run: mkdir -p build/release

      - name: Get release version
        id: vars
        run: echo "version=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Configure build with Clang
        run: |
          cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo ..
        shell: bash
        env:
          BUILD_VERSION: ${{ steps.vars.outputs.version }}
          BUILD_OS: ${{ matrix.os }}
        working-directory: build

      - name: Build
        run: |
          cmake --build . --config RelWithDebInfo --target package
        shell: bash
        working-directory: build

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: EFIBootEditor-${{ github.sha }}-${{ matrix.os }}-qt-${{ matrix.qt_version }}-Clang
          if-no-files-found: error
          path: build/dist/EFIBootEditor-*

  upload-linux-asset:
    name: Upload Linux release asset ${{ matrix.os }} Qt ${{ matrix.qt_version }} with ${{ matrix.compiler }}
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    needs: build-linux
    strategy:
      matrix:
        os: [ubuntu-20.04, ubuntu-22.04]
        qt_version:
          - 5.15.2 # OS LTS
          - 6.2.4 # LTS Standard
          - 6.4.2 # latest
        compiler:
          - Clang
          - GCC
        include:
          - os: ubuntu-18.04
            qt_version: 5.15.2
            compiler: Clang
          - os: ubuntu-18.04
            qt_version: 5.15.2
            compiler: GCC

    steps:
      - name: Get release version
        id: vars
        run: echo "version=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT

      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          name: EFIBootEditor-${{ github.sha }}-${{ matrix.os }}-qt-${{ matrix.qt_version }}-${{ matrix.compiler }}
          path: .

      - name: Upload TZST
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: EFIBootEditor-${{ steps.vars.outputs.version }}-${{ matrix.os }}-qt-${{ matrix.qt_version }}.tar.zst
          asset_name: EFIBootEditor-${{ steps.vars.outputs.version }}-${{ matrix.os }}-qt-${{ matrix.qt_version }}-${{ matrix.compiler }}.tar.zst
          asset_content_type: application/tar+gzip

      - name: Upload DEB
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: EFIBootEditor-${{ steps.vars.outputs.version }}-${{ matrix.os }}-qt-${{ matrix.qt_version }}.deb
          asset_name: EFIBootEditor-${{ steps.vars.outputs.version }}-${{ matrix.os }}-qt-${{ matrix.qt_version }}-${{ matrix.compiler }}.deb
          asset_content_type: application/vnd.debian.binary-package

      - name: Upload DDEB
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: EFIBootEditor-${{ steps.vars.outputs.version }}-${{ matrix.os }}-qt-${{ matrix.qt_version }}-dbgsym.ddeb
          asset_name: EFIBootEditor-${{ steps.vars.outputs.version }}-${{ matrix.os }}-qt-${{ matrix.qt_version }}-${{ matrix.compiler }}-dbgsym.ddeb
          asset_content_type: application/vnd.debian.binary-package

  upload-windows-asset:
    name: Upload Windows release asset ${{ matrix.os }} Qt ${{ matrix.qt_version }} with ${{ matrix.compiler }}
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    needs: build-windows
    strategy:
      matrix:
        os: [windows-2019, windows-2022]
        qt_version:
          - 5.15.2 # OS LTS
          - 6.2.4 # LTS Standard
          - 6.4.2 # latest
        compiler:
          - Clang
          - MSVC

    steps:
      - name: Get release version
        id: vars
        run: echo "version=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT

      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          name: EFIBootEditor-${{ github.sha }}-${{ matrix.os }}-qt-${{ matrix.qt_version }}-${{ matrix.compiler }}
          path: .

      - name: Upload ZIP
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: EFIBootEditor-${{ steps.vars.outputs.version }}-${{ matrix.os }}-qt-${{ matrix.qt_version }}.zip
          asset_name: EFIBootEditor-${{ steps.vars.outputs.version }}-${{ matrix.os }}-qt-${{ matrix.qt_version }}-${{ matrix.compiler }}.zip
          asset_content_type: application/zip

      - name: Upload MSI
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: EFIBootEditor-${{ steps.vars.outputs.version }}-${{ matrix.os }}-qt-${{ matrix.qt_version }}.msi
          asset_name: EFIBootEditor-${{ steps.vars.outputs.version }}-${{ matrix.os }}-qt-${{ matrix.qt_version }}-${{ matrix.compiler }}.msi
          asset_content_type: application/x-ole-storage

  upload-macos-asset:
    name: Upload MacOS release asset ${{ matrix.os }} Qt ${{ matrix.qt_version }} with ${{ matrix.compiler }}
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    needs: build-macos
    strategy:
      matrix:
        os: [macos-11, macos-12]
        qt_version:
          - 5.15.2 # OS LTS
          - 6.2.4 # LTS Standard
          - 6.4.2 # latest
        compiler:
          - Clang

    steps:
      - name: Get release version
        id: vars
        run: echo "version=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT

      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          name: EFIBootEditor-${{ github.sha }}-${{ matrix.os }}-qt-${{ matrix.qt_version }}-${{ matrix.compiler }}
          path: .

      - name: Upload TZST
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: EFIBootEditor-${{ steps.vars.outputs.version }}-${{ matrix.os }}-qt-${{ matrix.qt_version }}.tar.zst
          asset_name: EFIBootEditor-${{ steps.vars.outputs.version }}-${{ matrix.os }}-qt-${{ matrix.qt_version }}-${{ matrix.compiler }}.tar.zst
          asset_content_type: application/tar+gzip

      - name: Upload DMG
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: EFIBootEditor-${{ steps.vars.outputs.version }}-${{ matrix.os }}-qt-${{ matrix.qt_version }}.dmg
          asset_name: EFIBootEditor-${{ steps.vars.outputs.version }}-${{ matrix.os }}-qt-${{ matrix.qt_version }}-${{ matrix.compiler }}.dmg
          asset_content_type: application/octet-stream
